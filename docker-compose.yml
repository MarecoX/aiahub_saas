version: '3.8'

services:
  # Serviço da API (FastAPI)
  api:
    image: marsllator/kestra-api-manager:latest
    build:
      context: .
      dockerfile: Dockerfile
    command: uvicorn api.main:app --host 0.0.0.0 --port 8000
    networks:
      - network_public
    environment:
      - DATABASE_CONNECTION_URI=${DATABASE_CONNECTION_URI}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ADMIN_API_SECRET=${ADMIN_API_SECRET}
      - META_APP_ID=${META_APP_ID}
      - META_APP_SECRET=${META_APP_SECRET}
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.kestra_api.rule=Host(`api.aiahub.com.br`)"
        - "traefik.http.routers.kestra_api.entrypoints=websecure"
        - "traefik.http.routers.kestra_api.tls.certresolver=letsencryptresolver"
        - "traefik.http.services.kestra_api.loadbalancer.server.port=8000"

  # Serviço do Painel (Streamlit)
  dashboard:
    image: marsllator/kestra-api-manager:latest
    build:
      context: .
      dockerfile: Dockerfile
    command: streamlit run app.py --server.port 8501 --server.address 0.0.0.0 --server.headless true --server.fileWatcherType none --browser.gatherUsageStats false --server.enableCORS false --server.enableXsrfProtection false --server.enableWebsocketCompression false
    networks:
      - network_public
    environment:
      - DATABASE_CONNECTION_URI=${DATABASE_CONNECTION_URI}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.kestra_dashboard.rule=Host(`acesso.aiahub.com.br`)"
        - "traefik.http.routers.kestra_dashboard.entrypoints=websecure"
        - "traefik.http.routers.kestra_dashboard.tls.certresolver=letsencryptresolver"
        - "traefik.http.routers.kestra_dashboard.service=kestra_dashboard"
        - "traefik.http.services.kestra_dashboard.loadbalancer.server.port=8501"
        - "traefik.http.services.kestra_dashboard.loadbalancer.sticky.cookie=true"
        - "traefik.http.middlewares.force-https.headers.customrequestheaders.X-Forwarded-Proto=https"
        - "traefik.http.routers.kestra_dashboard.middlewares=force-https"

networks:
  network_public:
    name: network_public
    external: true
