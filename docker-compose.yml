version: '3.8'

services:
  # Serviço da API (FastAPI)
  api:
    image: marsllator/kestra-api-manager:latest
    build:
      context: .
      dockerfile: Dockerfile
    command: uvicorn api.main:app --host 0.0.0.0 --port 8000
    networks:
      - network_public
    environment:
      - DATABASE_CONNECTION_URI=${DATABASE_CONNECTION_URI}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ADMIN_API_SECRET=${ADMIN_API_SECRET}
      - META_APP_ID=${META_APP_ID}
      - META_APP_SECRET=${META_APP_SECRET}
      - REDIS_URL=redis://redis:6379


    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.kestra_api.rule=Host(`api.aiahub.com.br`)"
        - "traefik.http.routers.kestra_api.entrypoints=websecure"
        - "traefik.http.routers.kestra_api.tls.certresolver=letsencryptresolver"
        - "traefik.http.services.kestra_api.loadbalancer.server.port=8000"
        # Security Middlewares
        - "traefik.http.middlewares.api-ratelimit.ratelimit.average=100"
        - "traefik.http.middlewares.api-ratelimit.ratelimit.burst=50"
        - "traefik.http.middlewares.api-ratelimit.ratelimit.period=1m"
        - "traefik.http.middlewares.api-security.headers.frameDeny=true"
        - "traefik.http.middlewares.api-security.headers.browserXssFilter=true"
        - "traefik.http.middlewares.api-security.headers.contentTypeNosniff=true"
        - "traefik.http.middlewares.api-security.headers.referrerPolicy=strict-origin-when-cross-origin"
        - "traefik.http.routers.kestra_api.middlewares=api-ratelimit,api-security"

  # Serviço do Painel (Streamlit)
  dashboard:
    image: marsllator/kestra-api-manager:latest
    build:
      context: .
      dockerfile: Dockerfile
    command: streamlit run app.py --server.port 8501 --server.address 0.0.0.0 --server.headless true --server.fileWatcherType none --browser.gatherUsageStats false --server.enableCORS false --server.enableXsrfProtection false --server.enableWebsocketCompression false
    networks:
      - network_public
    environment:
      - DATABASE_CONNECTION_URI=${DATABASE_CONNECTION_URI}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.kestra_dashboard.rule=Host(`acesso.aiahub.com.br`)"
        - "traefik.http.routers.kestra_dashboard.entrypoints=websecure"
        - "traefik.http.routers.kestra_dashboard.tls.certresolver=letsencryptresolver"
        - "traefik.http.routers.kestra_dashboard.service=kestra_dashboard"
        - "traefik.http.services.kestra_dashboard.loadbalancer.server.port=8501"
        - "traefik.http.services.kestra_dashboard.loadbalancer.sticky.cookie=true"
        # Security Middlewares
        - "traefik.http.middlewares.dash-security.headers.frameDeny=true"
        - "traefik.http.middlewares.dash-security.headers.browserXssFilter=true"
        - "traefik.http.middlewares.dash-security.headers.contentTypeNosniff=true"
        - "traefik.http.middlewares.dash-security.headers.customrequestheaders.X-Forwarded-Proto=https"
        - "traefik.http.middlewares.dash-ratelimit.ratelimit.average=50"
        - "traefik.http.middlewares.dash-ratelimit.ratelimit.burst=30"
        - "traefik.http.routers.kestra_dashboard.middlewares=dash-security,dash-ratelimit"

  # Serviço Redis (Cache & Debounce)
  redis:
    image: redis:alpine
    restart: always
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - network_public
    deploy:
      mode: replicated
      replicas: 1

  # Serviço de Documentação (Sênior Docs)
  docs:
    image: squidfunk/mkdocs-material
    restart: always
    ports:
      - "8008:8000"
    volumes:
      - ./:/docs
    deploy:
      mode: replicated
      replicas: 1
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.kestra_docs.rule=Host(`docs.aiahub.com.br`)"
        - "traefik.http.routers.kestra_docs.entrypoints=websecure"
        - "traefik.http.routers.kestra_docs.tls.certresolver=letsencryptresolver"
        - "traefik.http.services.kestra_docs.loadbalancer.server.port=8000"

networks:
  network_public:
    name: network_public
    external: true

volumes:
  redis_data:
